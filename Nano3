#!/bin/bash
set -e

echo "Updating system..."
sudo apt update
sudo apt install -y \
    build-essential \
    git \
    wget \
    libopenblas-dev \
    python3 \
    python3-pip

# -------------------------------------------------
# Install modern CMake (does NOT replace system one)
# -------------------------------------------------

CMAKE_VERSION=3.27.9

if ! cmake --version | grep -q "$CMAKE_VERSION"; then
    echo "Installing CMake $CMAKE_VERSION..."

    wget https://github.com/Kitware/CMake/releases/download/v$CMAKE_VERSION/cmake-$CMAKE_VERSION-linux-aarch64.sh
    chmod +x cmake-$CMAKE_VERSION-linux-aarch64.sh
    sudo ./cmake-$CMAKE_VERSION-linux-aarch64.sh --skip-license --prefix=/usr/local
fi

echo "CMake version:"
cmake --version

# -------------------------------------------------
# Clone llama.cpp
# -------------------------------------------------

if [ ! -d "llama.cpp" ]; then
    git clone https://github.com/ggerganov/llama.cpp
fi

cd llama.cpp
mkdir -p build
cd build

echo "Configuring build for Jetson Nano (CUDA SM53)..."

cmake .. \
    -DLLAMA_CUBLAS=ON \
    -DCMAKE_CUDA_ARCHITECTURES=53 \
    -DCMAKE_BUILD_TYPE=Release

echo "Building..."
cmake --build . -j$(nproc)

echo "Build complete!"
echo "Binary located at: llama.cpp/build/bin/"
